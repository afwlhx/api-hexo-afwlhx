# ===============================
# ğŸ—ï¸ åç§°ï¼š.NET æ„å»ºã€å‘å¸ƒä¸å‘å¸ƒ Release
# å½“ main åˆ†æ”¯æœ‰æ–°çš„æäº¤æ—¶è‡ªåŠ¨æ‰§è¡Œ
# ===============================

name: .NET Build, Publish & Release

on:
  push:
    branches: [ "main" ]  # ç›‘å¬ main åˆ†æ”¯æ¨é€äº‹ä»¶

# âœ… æˆæƒ workflow æœ‰æƒé™åˆ›å»º Releaseï¼ˆé»˜è®¤åªè¯»ï¼‰
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç¯å¢ƒ

    steps:
    # ===============================
    # 1ï¸âƒ£ æ‹‰å–ä»“åº“ä»£ç 
    # ===============================
    - name: Checkout code
      uses: actions/checkout@v4
      # è¯´æ˜ï¼šæŠŠå½“å‰ GitHub ä»“åº“çš„ä»£ç æ£€å‡ºåˆ° runner å·¥ä½œç›®å½•

    # ===============================
    # 2ï¸âƒ£ å®‰è£… .NET 8 SDK
    # ===============================
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x  # æŒ‡å®šä½¿ç”¨ .NET 8.x ç‰ˆæœ¬
      # è¯´æ˜ï¼šå®˜æ–¹ setup-dotnet åŠ¨ä½œä¼šè‡ªåŠ¨å®‰è£…å¯¹åº” SDK

    # ===============================
    # 3ï¸âƒ£ è¿˜åŸä¾èµ–
    # ===============================
    - name: Restore dependencies
      run: dotnet restore api-hexo-afwlhx.sln
      # è¯´æ˜ï¼šæ ¹æ® .sln æˆ– .csproj æ–‡ä»¶è¿˜åŸ NuGet åŒ…

    # ===============================
    # 4ï¸âƒ£ ç¼–è¯‘é¡¹ç›®
    # ===============================
    - name: Build
      run: dotnet build api-hexo-afwlhx.sln --configuration Release --no-restore
      # è¯´æ˜ï¼šç¼–è¯‘ä¸º Release æ¨¡å¼ï¼ˆä¸å†é‡å¤ restoreï¼‰

    # ===============================
    # 5ï¸âƒ£ è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœæœ‰ï¼‰
    # ===============================
    - name: Test
      run: dotnet test api-hexo-afwlhx.sln --no-build --verbosity normal || echo "No tests found"
      # è¯´æ˜ï¼š
      # - è‹¥æœ‰å•å…ƒæµ‹è¯•ä¼šæ‰§è¡Œ
      # - è‹¥æ— æµ‹è¯•é¡¹ç›®åˆ™è¾“å‡ºæç¤ºï¼Œä¸ä¸­æ–­æµç¨‹

    # ===============================
    # 6ï¸âƒ£ å‘å¸ƒé¡¹ç›®
    # ===============================
    - name: Publish project
      run: dotnet publish ./api-hexo-afwlhx/api-hexo-afwlhx.csproj -c Release -o ./publish
      # è¯´æ˜ï¼š
      # - å°†ç¼–è¯‘äº§ç‰©å‘å¸ƒåˆ° ./publish æ–‡ä»¶å¤¹
      # - åŒ…å«æ‰€æœ‰ä¾èµ–æ–‡ä»¶ï¼Œå¯ç›´æ¥éƒ¨ç½²è¿è¡Œ

    # ===============================
    # 7ï¸âƒ£ å‹ç¼©å‘å¸ƒæ–‡ä»¶
    # ===============================
    - name: Compress published files
      run: |
        cd ./publish
        zip -r ../publish.zip ./*  # æ‰“åŒ…ä¸º publish.zip
        cd ..
      # è¯´æ˜ï¼šå°†æ‰€æœ‰å‘å¸ƒè¾“å‡ºå‹ç¼©ï¼Œæ–¹ä¾¿ä¸Šä¼ ä¸º Release èµ„äº§

    # ===============================
    # 8ï¸âƒ£ ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆä¾›å…¶ä»– workflow ä½¿ç”¨ï¼‰
    # ===============================
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: published-app  # ä¸Šä¼ çš„åå­—
        path: ./publish.zip  # ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„
      # è¯´æ˜ï¼šè¿™ä¸€æ­¥ä¼šåœ¨ â€œActions -> Artifactsâ€ ä¸­çœ‹åˆ° publish.zip æ–‡ä»¶

    # ===============================
    # 9ï¸âƒ£ è‡ªåŠ¨åˆ›å»º GitHub Release
    # ===============================
    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        # åŠ¨æ€ç”Ÿæˆç‰ˆæœ¬å·ï¼ˆå–æäº¤æ—¶é—´çš„å‰10ä¸ªå­—ç¬¦ï¼Œå³æ—¥æœŸéƒ¨åˆ†ï¼‰
        tag_name: v${{ github.event.head_commit.timestamp[0:10] }}
        name: å‘å¸ƒç‰ˆæœ¬ ${{ github.event.head_commit.timestamp[0:10] }}
        body: |
          ğŸš€ è‡ªåŠ¨æ„å»ºå®Œæˆï¼
          - åˆ†æ”¯: ${{ github.ref_name }}
          - æäº¤: ${{ github.sha }}
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
        files: ./publish.zip  # ä¸Šä¼ çš„æ–‡ä»¶ä½œä¸º Release é™„ä»¶
      env:
        # GitHub è‡ªåŠ¨æ³¨å…¥çš„ Tokenï¼Œç”¨äºæˆæƒåˆ›å»º Release
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
