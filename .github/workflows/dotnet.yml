name: .NET Build, Publish & Release

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # âœ… è¿˜åŸä¾èµ–
    - name: Restore dependencies
      run: dotnet restore api-hexo-afwlhx.sln

    # âœ… æ„å»º Release
    - name: Build
      run: dotnet build api-hexo-afwlhx.sln --configuration Release --no-restore

    # âœ… æµ‹è¯•
    - name: Test
      run: dotnet test api-hexo-afwlhx.sln --no-build --verbosity normal || echo "No tests found"

    # âœ… å‘å¸ƒå…·ä½“é¡¹ç›®ï¼ˆä¸è¦å¯¹ .sln ä½¿ç”¨ -oï¼‰
    - name: Publish project
      run: dotnet publish ./api-hexo-afwlhx/api-hexo-afwlhx.csproj -c Release -o ./publish

    # âœ… å‹ç¼©å‘å¸ƒç»“æœä¸º zip
    - name: Compress published files
      run: |
        cd ./publish
        zip -r ../publish.zip ./*
        cd ..

    # âœ… ä¸Šä¼ æ„å»ºäº§ç‰©ä¾› Actions é¡µé¢ä¸‹è½½
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: published-app
        path: ./publish.zip

    # âœ… è‡ªåŠ¨åˆ›å»º GitHub Release å¹¶ä¸Šä¼  zip åŒ…
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: release-${{ github.run_number }}
        name: Release ${{ github.run_number }}
        body: |
          ğŸš€ è‡ªåŠ¨æ„å»ºå®Œæˆï¼
          - åˆ†æ”¯: ${{ github.ref_name }}
          - æäº¤: ${{ github.sha }}
          - æ„å»ºå·: ${{ github.run_number }}
        files: ./publish.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
